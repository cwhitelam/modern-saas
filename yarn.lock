import { FastifyInstance, FastifyPluginOptions } from 'fastify'
import AuthService from '../../services/auth'
import { signup, signin, token } from './schema'

export default function (app: FastifyInstance, opts: FastifyPluginOptions, next: () => void) {
  const authService = new AuthService(app)

  app.route({
    method: 'POST',
    schema: signup,
    url: '/signup',
    handler: async (request: any, reply: any) => {
      const { email, name, password } = request.body
      const signup = await authService.signup(email, name, password)

      reply.code(201).send(signup)
    }
  })

  app.route({
    method: 'POST',
    schema: signin,
    url: '/signin',
    handler: async (request: any, reply: any) => {
      const { email, password } = request.body
      const signin = await authService.signin(email, password)

      reply.send(signin)
    }
  })

  app.route({
    method: 'POST',
    schema: token,
    url: '/token',
    handler: async (request: any, reply: any) => {
      const { refreshToken } = request.body
      const token = await authService.token(refreshToken)

      reply.send(token)
    }
  })

  app.route({
    method: 'GET',
    schema: token,
    url: '/profile',
    preHandler: [],
    handler: async (request: any, reply: any) => {
      const profile = await authService.profile(2)

      reply.send(profile)
    }
  })

  next()
}
